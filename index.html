<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VDC Contador de Patas — SOLO RF</title>

  <style>
    :root{
      --bg1:#08101f; --bg2:#060b16;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.10);
      --text:#eaf0ff; --muted: rgba(234,240,255,.65);
      --green:#32d07f; --amber:#caa24a; --red:#e05555; --blue:#4aa3ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      background: radial-gradient(1200px 700px at 20% 10%, #0b2a5a 0%, var(--bg1) 45%, var(--bg2) 100%);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      padding:18px;
    }
    .topbar{display:flex;align-items:center;gap:12px;margin-bottom:14px}
    .pill{
      display:inline-flex;align-items:center;gap:10px;
      padding:8px 12px;border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);border-radius:999px;
      font-weight:700;letter-spacing:.3px
    }
    .dot{width:10px;height:10px;border-radius:50%;background:var(--green);box-shadow:0 0 14px rgba(50,208,127,.7)}
    h1{margin:0;font-size:22px}
    .sub{color:var(--muted);margin-top:4px;font-size:13px}

    .grid{display:grid;grid-template-columns: 1.25fr .95fr;gap:14px;align-items:start}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}

    .card{
      border:1px solid var(--stroke);
      background:var(--card);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    .card h2{margin:0 0 10px 0;font-size:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .spacer{flex:1}
    .btn{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:12px 14px;border-radius:14px;
      font-weight:800;cursor:pointer;
      min-width:160px;text-align:center;
      user-select:none;
    }
    .btn:active{transform:scale(.99)}
    .btn.green{background:rgba(50,208,127,.22);border-color:rgba(50,208,127,.45)}
    .btn.amber{background:rgba(202,162,74,.22);border-color:rgba(202,162,74,.45)}
    .btn.red{background:rgba(224,85,85,.22);border-color:rgba(224,85,85,.45)}
    .btn.blue{background:rgba(74,163,255,.20);border-color:rgba(74,163,255,.42)}
    .btn.ghost{opacity:.65}
    .btn.full{width:100%}
    .btn.small{padding:10px 12px;min-width:unset}

    .big{
      font-size:84px;font-weight:900;line-height:1;letter-spacing:-2px;
      margin:10px 0 0 0;
    }
    .label{color:var(--muted);font-weight:700}
    .statusline{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
      font-weight:800;font-size:12px;color:var(--muted)
    }
    .tag strong{color:var(--text)}
    .tag.ok{border-color:rgba(50,208,127,.4)}
    .tag.warn{border-color:rgba(202,162,74,.4)}
    .tag.bad{border-color:rgba(224,85,85,.4)}
    .tag.blue{border-color:rgba(74,163,255,.4)}

    .field{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.20);
      color:var(--text);
      font-weight:700;
      outline:none;
    }
    .mini{font-size:12px;color:var(--muted);margin-top:8px}

    .camWrap{position:relative;border-radius:18px;overflow:hidden;border:1px solid var(--stroke)}
    video{width:100%;display:block;background:#000;aspect-ratio: 16/9;object-fit:cover}
    canvas{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}

    .flash{
      position:fixed;inset:0;pointer-events:none;
      background:rgba(50,208,127,.18);
      opacity:0;transition:opacity .12s ease;
    }
    .flash.on{opacity:1}
    .log{max-height:320px;overflow:auto;border-radius:14px;border:1px solid var(--stroke);padding:10px;background:rgba(0,0,0,.18)}
    .logItem{display:flex;justify-content:space-between;gap:10px;padding:8px 8px;border-bottom:1px solid rgba(255,255,255,.06)}
    .logItem:last-child{border-bottom:none}
    .logItem b{font-weight:900}
    .right{text-align:right;color:var(--muted);font-weight:800}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:980px){.two{grid-template-columns:1fr}}
    .sliderRow{display:grid;grid-template-columns:1fr 110px;gap:10px;align-items:center}
    input[type="range"]{width:100%}
    .num{padding:10px 10px;border-radius:12px;border:1px solid var(--stroke);background:rgba(0,0,0,.18);text-align:center;font-weight:900}
  </style>

  <!-- Roboflow inferencejs -->
  <script src="https://cdn.jsdelivr.net/npm/inferencejs"></script>
</head>

<body>
  <div class="flash" id="flash"></div>

  <div class="topbar">
    <div class="pill"><span class="dot"></span>ONLINE</div>
    <div>
      <h1>VDC Contador de Patas</h1>
      <div class="sub">SOLO RF (Roboflow) • Guardado local • Conteo por cruce de línea</div>
    </div>
  </div>

  <div class="grid">
    <!-- IZQUIERDA -->
    <div class="card">
      <h2>Conteo</h2>

      <div class="row">
        <div>
          <div class="big" id="count">0</div>
          <div class="label">patas</div>
        </div>
        <div class="spacer"></div>

        <div style="min-width:320px; width:420px; max-width:100%">
          <input class="field" id="sessionName" placeholder="Nombre de sesión (opcional) Ej. Camión 7:00 AM - Martes">
          <div class="statusline">
            <span class="tag ok"><strong>Guardado:</strong> <span id="savedText">listo</span></span>
            <span class="tag blue"><strong>Último:</strong> <span id="lastSaved">—</span></span>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div class="btn green" id="btnStart">INICIAR</div>
        <div class="btn ghost" id="btnPause">PAUSAR</div>
        <div class="btn amber" id="btnPlus">+1 PATA</div>
        <div class="btn ghost" id="btnUndo">DESHACER</div>
        <div class="btn red" id="btnReset">REINICIAR A CERO</div>
        <div class="btn blue" id="btnCSV">EXPORTAR (CSV)</div>
      </div>

      <div class="hr"></div>

      <div class="two">
        <div class="card" style="padding:12px">
          <h2 style="margin:0 0 10px 0">Modelo RF</h2>

          <label class="label">Publishable Key (Roboflow)</label>
          <input class="field" id="rfKey" />

          <div class="mini">Usa tu <b>publishable key</b> (rf_...).</div>

          <div class="hr"></div>

          <label class="label">Model URL (Roboflow Instant)</label>
          <input class="field" id="modelUrl" />

          <div class="mini">Ej: <b>marcianoper/vdc-patas-instant-4</b></div>

          <div class="hr"></div>

          <div class="row">
            <button class="btn green small" id="btnLoadModel">CARGAR MODELO</button>
            <span class="tag warn"><strong>Estado:</strong> <span id="rfState">NO CARGADO</span></span>
          </div>

          <div class="mini" style="margin-top:10px">
            ⚠️ iPhone: evita <b>Nav. privada</b>. Si está en privada, los workers fallan.
          </div>
        </div>

        <div class="card" style="padding:12px">
          <h2 style="margin:0 0 10px 0">Ajustes (RF)</h2>

          <div class="sliderRow">
            <div>
              <div class="label">ROI (tamaño del cuadro)</div>
              <input id="roi" type="range" min="35" max="90" value="70">
            </div>
            <div class="num"><span id="roiVal">70</span>%</div>
          </div>

          <div class="sliderRow">
            <div>
              <div class="label">Línea de conteo (altura dentro del ROI)</div>
              <input id="lineY" type="range" min="15" max="85" value="60">
            </div>
            <div class="num"><span id="lineYVal">60</span>%</div>
          </div>

          <div class="sliderRow">
            <div>
              <div class="label">Confianza mínima</div>
              <input id="rfConf" type="range" min="25" max="95" value="70">
            </div>
            <div class="num"><span id="rfConfVal">0.70</span></div>
          </div>

          <div class="sliderRow">
            <div>
              <div class="label">RF: FPS (requests/seg)</div>
              <input id="rfFps" type="range" min="1" max="6" value="3">
            </div>
            <div class="num"><span id="rfFpsVal">3</span></div>
          </div>

          <div class="sliderRow">
            <div>
              <div class="label">Cooldown (ms) anti-doble</div>
              <input id="cool" type="range" min="600" max="3500" value="1600">
            </div>
            <div class="num"><span id="coolVal">1600</span></div>
          </div>

          <div class="mini">
            Recomendado: conf 0.60–0.85 • FPS 2–4 • cooldown 1200–2000.
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="card" style="padding:12px">
        <h2 style="margin:0 0 10px 0">Cámara</h2>
        <div class="row">
          <button class="btn green small" id="btnCamOn">ACTIVAR CÁMARA</button>
          <button class="btn small" id="btnCamOff">APAGAR</button>
          <button class="btn small" id="btnFlip">CAMBIAR CÁMARA</button>
          <span class="tag blue"><strong>Hora:</strong> <span id="clock">—</span></span>
          <span class="tag"><strong>Debug:</strong> <span id="dbgText">OFF</span></span>
          <button class="btn small" id="btnDebug">DEBUG</button>
        </div>

        <div class="hr"></div>

        <div class="camWrap">
          <video id="video" playsinline muted></video>
          <canvas id="cv"></canvas>
        </div>
      </div>
    </div>

    <!-- DERECHA -->
    <div class="card">
      <h2>Bitácora</h2>
      <div class="row">
        <span class="tag"><strong id="logCount">0</strong> evento(s)</span>
        <span class="spacer"></span>
        <span class="tag blue"><strong>Estado:</strong> <span id="runState">PAUSADO</span></span>
      </div>

      <div class="hr"></div>
      <div class="log" id="log"></div>

      <div class="hr"></div>
      <div class="mini">
        iPhone Safari: Ajustes → Safari → Cámara → <b>Permitir</b>.<br/>
        Si da error RF: sal de <b>Nav. privada</b> y recarga.
      </div>
    </div>
  </div>

  <script>
    // ======================
    //  Estado + Persistencia
    // ======================
    const LS_KEY = "vdc_patas_rf_only_v1";
    let state = {
      count: 0,
      running: false,
      debug: false,
      sessionName: "",
      events: [],
      lastSaved: null,

      // ajustes
      roiPct: 70,
      lineYPct: 60,
      cooldownMs: 1600,
      rfConf: 0.70,
      rfFps: 3,

      // roboflow
      publishableKey: "rf_cZVpt4nSGwabGVW3Fr0rzawLieC2",
      modelUrl: "marcianoper/vdc-patas-instant-4",

      camera: { facingMode: "environment" }
    };

    const $ = (id)=>document.getElementById(id);

    // UI refs
    const flash = $("flash");
    const countEl = $("count");
    const logEl = $("log");
    const logCountEl = $("logCount");
    const savedText = $("savedText");
    const lastSavedEl = $("lastSaved");
    const runState = $("runState");
    const clockEl = $("clock");
    const dbgText = $("dbgText");
    const rfState = $("rfState");

    const video = $("video");
    const canvas = $("cv");
    const ctx = canvas.getContext("2d");

    // sliders
    const roi = $("roi"), lineY = $("lineY"), rfConf = $("rfConf"), rfFps = $("rfFps"), cool = $("cool");
    const roiVal = $("roiVal"), lineYVal = $("lineYVal"), rfConfVal = $("rfConfVal"), rfFpsVal = $("rfFpsVal"), coolVal = $("coolVal");

    // audio
    let audioCtx = null;
    function beep(){
      try{
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = "sine";
        o.frequency.value = 880;
        g.gain.value = 0.06;
        o.connect(g); g.connect(audioCtx.destination);
        o.start();
        setTimeout(()=>{o.stop();}, 80);
      }catch(e){}
    }
    function vibrate(){ try{ navigator.vibrate?.(60); }catch(e){} }

    function fmtTime(iso){
      try{ return new Date(iso).toLocaleString(); }catch(e){ return "—"; }
    }

    function save(){
      state.lastSaved = new Date().toISOString();
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      savedText.textContent = "listo";
      lastSavedEl.textContent = fmtTime(state.lastSaved);
    }
    function autosave(){
      savedText.textContent = "guardando…";
      save();
    }

    function pushEvent(type, extra={}){
      const ev = { type, ts: new Date().toISOString(), count: state.count, ...extra };
      state.events.unshift(ev);
      state.events = state.events.slice(0, 140);
      autosave();
      renderLog();
    }

    function renderLog(){
      logEl.innerHTML = "";
      logCountEl.textContent = state.events.length;
      if(state.events.length === 0){
        logEl.innerHTML = `<div class="logItem"><b>Sin eventos</b><span class="right">Activa cámara y carga modelo</span></div>`;
        return;
      }
      for(const ev of state.events){
        const t = new Date(ev.ts).toLocaleString();
        const note = ev.note ? ` • ${ev.note}` : "";
        logEl.insertAdjacentHTML("beforeend", `
          <div class="logItem">
            <div>
              <b>${ev.type}</b>
              <div class="mini">${t}${note}</div>
            </div>
            <div class="right">Conteo ${ev.count}</div>
          </div>
        `);
      }
    }

    function updateUI(){
      countEl.textContent = state.count;
      runState.textContent = state.running ? "CORRIENDO" : "PAUSADO";
      dbgText.textContent = state.debug ? "ON" : "OFF";
      lastSavedEl.textContent = state.lastSaved ? fmtTime(state.lastSaved) : "—";

      roiVal.textContent = state.roiPct;
      lineYVal.textContent = state.lineYPct;
      rfConfVal.textContent = state.rfConf.toFixed(2);
      rfFpsVal.textContent = state.rfFps;
      coolVal.textContent = state.cooldownMs;

      $("sessionName").value = state.sessionName || "";
      $("rfKey").value = state.publishableKey || "";
      $("modelUrl").value = state.modelUrl || "";
    }

    function load(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(raw){
          const s = JSON.parse(raw);
          state = {...state, ...s};
        }
      }catch(e){}

      // apply slider values
      roi.value = state.roiPct;
      lineY.value = state.lineYPct;
      cool.value = state.cooldownMs;
      rfConf.value = Math.round(state.rfConf*100);
      rfFps.value = state.rfFps;

      updateUI();
      renderLog();
    }

    function flashGreen(){
      flash.classList.add("on");
      setTimeout(()=>flash.classList.remove("on"), 120);
    }

    function countedVisual(note=""){
      flashGreen();
      beep();
      vibrate();
      pushEvent("CONTEO +1", note ? {note} : {});
    }

    // ======================
    //  Controles
    // ======================
    $("btnStart").onclick = ()=>{ state.running = true; autosave(); pushEvent("INICIAR"); updateUI(); };
    $("btnPause").onclick = ()=>{ state.running = false; autosave(); pushEvent("PAUSAR"); updateUI(); };

    $("btnPlus").onclick = ()=>{ state.count += 1; countedVisual("manual"); updateUI(); };
    $("btnUndo").onclick = ()=>{ state.count = Math.max(0, state.count - 1); pushEvent("DESHACER"); autosave(); updateUI(); };
    $("btnReset").onclick = ()=>{ state.count = 0; pushEvent("REINICIAR"); autosave(); updateUI(); };

    $("btnCSV").onclick = ()=>{
      const rows = [["ts","type","count","note"]];
      for(const ev of [...state.events].reverse()){
        rows.push([ev.ts, ev.type, ev.count, ev.note || ""]);
      }
      const csv = rows.map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `vdc_patas_${(state.sessionName||"sesion").replaceAll(" ","_")}_${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
      pushEvent("EXPORTAR CSV");
    };

    $("sessionName").oninput = (e)=>{ state.sessionName = e.target.value || ""; autosave(); updateUI(); };

    $("btnDebug").onclick = ()=>{
      state.debug = !state.debug;
      pushEvent(state.debug ? "DEBUG ON" : "DEBUG OFF");
      autosave(); updateUI();
    };

    // sliders
    roi.oninput = ()=>{ state.roiPct = +roi.value; autosave(); updateUI(); };
    lineY.oninput = ()=>{ state.lineYPct = +lineY.value; autosave(); updateUI(); };
    cool.oninput = ()=>{ state.cooldownMs = +cool.value; autosave(); updateUI(); };
    rfConf.oninput = ()=>{ state.rfConf = (+rfConf.value)/100; autosave(); updateUI(); rfNeedsRestart=true; };
    rfFps.oninput = ()=>{ state.rfFps = +rfFps.value; autosave(); updateUI(); };

    // inputs
    $("rfKey").oninput = (e)=>{ state.publishableKey = e.target.value.trim(); autosave(); updateUI(); rfNeedsRestart=true; };
    $("modelUrl").oninput = (e)=>{ state.modelUrl = e.target.value.trim(); autosave(); updateUI(); rfNeedsRestart=true; };

    // ======================
    //  Cámara
    // ======================
    let stream = null;
    let usingFront = false;

    $("btnFlip").onclick = async ()=>{
      usingFront = !usingFront;
      state.camera.facingMode = usingFront ? "user" : "environment";
      pushEvent("CAMBIO CÁMARA", {note: state.camera.facingMode});
      await stopCamera();
      await startCamera();
    };
    $("btnCamOn").onclick = async ()=>{ await startCamera(); };
    $("btnCamOff").onclick = async ()=>{ await stopCamera(); pushEvent("CAMARA_OFF"); };

    async function startCamera(){
      try{
        if(stream) await stopCamera();
        const constraints = {
          audio:false,
          video:{
            facingMode: state.camera.facingMode,
            width: { ideal: 1280 },
            height:{ ideal: 720 }
          }
        };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        await video.play();
        pushEvent("CAMARA_ON");
        autosave();
      }catch(err){
        pushEvent("CAMARA_ERROR", {note: String(err?.message || err)});
        alert("No se pudo activar cámara. iPhone: Ajustes → Safari → Cámara → Permitir.");
      }
    }

    async function stopCamera(){
      try{
        if(video.srcObject){
          video.pause();
          video.srcObject = null;
        }
        if(stream){
          stream.getTracks().forEach(t=>t.stop());
          stream = null;
        }
      }catch(e){}
    }

    // ======================
    //  ROI + Overlay
    // ======================
    function ensureCanvas(){
      const w = video.videoWidth || 1280;
      const h = video.videoHeight || 720;
      if(canvas.width !== w || canvas.height !== h){
        canvas.width = w;
        canvas.height = h;
      }
    }

    function getROI(){
      const w = canvas.width, h = canvas.height;
      const pct = state.roiPct/100;
      const rw = Math.floor(w*pct);
      const rh = Math.floor(h*pct);
      const x = Math.floor((w - rw)/2);
      const y = Math.floor((h - rh)/2);
      return {x,y,rw,rh};
    }

    function drawOverlay(metricText=""){
      const {x,y,rw,rh} = getROI();
      const lineYLocal = y + Math.floor(rh*(state.lineYPct/100));

      // ROI
      ctx.lineWidth = 4;
      ctx.strokeStyle = "rgba(74,163,255,.75)";
      ctx.strokeRect(x,y,rw,rh);

      // line
      ctx.beginPath();
      ctx.moveTo(x, lineYLocal);
      ctx.lineTo(x+rw, lineYLocal);
      ctx.strokeStyle = "rgba(50,208,127,.85)";
      ctx.stroke();

      if(state.debug){
        ctx.fillStyle = "rgba(0,0,0,.55)";
        ctx.fillRect(14, 14, 640, 130);
        ctx.fillStyle = "rgba(255,255,255,.92)";
        ctx.font = "bold 18px ui-sans-serif, system-ui";
        ctx.fillText(`RF • ${state.running ? "RUN" : "PAUSE"} • conf=${state.rfConf.toFixed(2)} fps=${state.rfFps}`, 24, 42);
        ctx.font = "bold 16px ui-sans-serif, system-ui";
        ctx.fillText(metricText, 24, 72);
        ctx.font = "14px ui-sans-serif, system-ui";
        ctx.fillText(`cool=${state.cooldownMs}ms • model=${state.modelUrl}`, 24, 100);
      }
    }

    // ======================
    //  Roboflow (inferencejs) — FIXES IMPORTANTES
    // ======================
    let rfEngine = null;
    let rfWorkerId = null;

    let rfInitInFlight = false;
    let rfLastInitTry = 0;
    let rfInFlight = false;
    let rfLastInferAt = 0;

    let rfLastBelow = false;
    let lastCountAt = 0;

    let rfNeedsRestart = false;

    const roiCanvas = document.createElement("canvas");
    const roiCtx = roiCanvas.getContext("2d");

    function canCount(){
      const now = performance.now();
      return (now - lastCountAt) > state.cooldownMs;
    }

    function doCount(note="auto"){
      if(!state.running) return;
      if(!canCount()) return;
      state.count += 1;
      lastCountAt = performance.now();
      autosave();
      updateUI();
      countedVisual(note);
    }

    function parseModelUrl(modelUrl){
      // Espera: workspace/model-name-4  (Instant suele acabar en -<version>)
      // Devuelve: { model: "workspace/model-name", version: 4 }
      const s = (modelUrl || "").trim().replace(/^https?:\/\/.+?\//, ""); // por si pegan URL completa
      const parts = s.split("/");
      if(parts.length < 2) return null;

      const workspace = parts[0];
      const modelPart = parts.slice(1).join("/"); // por si hubiera subpaths (raro)
      const m = modelPart.match(/^(.*)-(\d+)$/);
      if(!m) return { model: `${workspace}/${modelPart}`, version: 1 }; // fallback
      return { model: `${workspace}/${m[1]}`, version: parseInt(m[2],10) };
    }

    async function stopRFWorker(){
      try{
        if(rfEngine && rfWorkerId){
          // Algunas versiones tienen stopWorker, otras no: intentamos
          if(typeof rfEngine.stopWorker === "function"){
            await rfEngine.stopWorker(rfWorkerId);
          }
        }
      }catch(e){}
      rfWorkerId = null;
      rfInitInFlight = false;
      rfLastInitTry = 0;
      rfState.textContent = "NO CARGADO";
    }

    async function ensureRFWorker(force=false){
      if(!window.InferenceEngine){
        pushEvent("RF error", {note:"inferencejs no cargó"});
        rfState.textContent = "ERROR SDK";
        return;
      }

      // si cambió key/model/conf, reinicia worker
      if(rfNeedsRestart){
        rfNeedsRestart = false;
        pushEvent("RF reinicio", {note:"cambios en config"});
        await stopRFWorker();
      }

      if(rfWorkerId) return;

      const now = performance.now();
      if(!force){
        // throttle reintentos (evita “Cannot create more than 2 workers”)
        if(rfInitInFlight) return;
        if(now - rfLastInitTry < 6000) return;
      }

      const parsed = parseModelUrl(state.modelUrl);
      if(!parsed){
        rfState.textContent = "MODEL URL INVÁLIDO";
        return;
      }
      if(!state.publishableKey || !state.publishableKey.startsWith("rf_")){
        rfState.textContent = "KEY INVÁLIDA";
        return;
      }

      rfInitInFlight = true;
      rfLastInitTry = now;
      rfState.textContent = "CARGANDO…";

      try{
        rfEngine = rfEngine || new window.InferenceEngine();

        const config = {
          scoreThreshold: state.rfConf,
          iouThreshold: 0.5,
          maxNumBoxes: 20
        };

        pushEvent("RF probando modelo…", {note:`${parsed.model}/${parsed.version}`});
        rfWorkerId = await rfEngine.startWorker(parsed.model, parsed.version, state.publishableKey, config);

        rfState.textContent = "LISTO ✅";
        pushEvent("RF listo", {note:`worker ${rfWorkerId}`});
      }catch(e){
        rfWorkerId = null;
        rfState.textContent = "FALLÓ ❌";
        pushEvent("RF fallo modelo", {note: `${state.modelUrl} -> ${String(e?.message || e)}`});
      }finally{
        rfInitInFlight = false;
      }
    }

    $("btnLoadModel").onclick = async ()=>{
      pushEvent("CARGAR MODELO", {note:"manual"});
      await stopRFWorker();
      await ensureRFWorker(true);
    };

    function rfShouldInfer(){
      const now = performance.now();
      const interval = 1000 / Math.max(1, state.rfFps);
      return (now - rfLastInferAt) >= interval;
    }

    async function stepRF(){
      await ensureRFWorker(false);

      if(!rfWorkerId){
        drawOverlay("RF: esperando worker… (sal de Nav. privada / revisa Model URL / Key)");
        return;
      }

      if(rfInFlight || !rfShouldInfer()){
        drawOverlay("RF: throttling…");
        return;
      }

      const {x,y,rw,rh} = getROI();
      const lineYLocal = y + Math.floor(rh*(state.lineYPct/100));

      roiCanvas.width = rw;
      roiCanvas.height = rh;
      roiCtx.drawImage(canvas, x, y, rw, rh, 0, 0, rw, rh);

      rfInFlight = true;
      rfLastInferAt = performance.now();

      try{
        const inferConfig = {
          scoreThreshold: state.rfConf,
          iouThreshold: 0.5,
          maxNumBoxes: 20
        };

        const preds = await rfEngine.infer(rfWorkerId, roiCanvas, inferConfig);

        // Dibuja todas si debug
        let best = null;
        let bestScore = 0;

        if(Array.isArray(preds)){
          for(const p of preds){
            const conf = Number(p.confidence ?? p.score ?? 0);
            const cls = (p.class || p.label || "").toString().toLowerCase();

            // Si el modelo tiene clase “pata”, prioriza esa.
            // Si no trae clase o no contiene “pata”, igual lo dejamos pasar si es el único modelo.
            const okClass = (!cls) || cls.includes("pata") || cls.includes("foot") || cls.includes("leg");
            if(!okClass) continue;

            if(conf > bestScore){
              bestScore = conf;
              best = p;
            }
          }
        }

        let metricText = `RF preds=${Array.isArray(preds) ? preds.length : 0}`;

        if(state.debug && Array.isArray(preds)){
          for(const p of preds){
            const conf = Number(p.confidence ?? p.score ?? 0);
            if(conf < state.rfConf) continue;
            const bx = Number(p.x ?? 0);
            const by = Number(p.y ?? 0);
            const bw = Number(p.width ?? 0);
            const bh = Number(p.height ?? 0);
            const gx = x + (bx - bw/2);
            const gy = y + (by - bh/2);
            ctx.lineWidth = 2;
            ctx.strokeStyle = "rgba(224,85,85,.55)";
            ctx.strokeRect(gx, gy, bw, bh);
          }
        }

        if(best){
          const bx = Number(best.x ?? 0);
          const by = Number(best.y ?? 0);
          const bw = Number(best.width ?? 0);
          const bh = Number(best.height ?? 0);

          const gx = x + (bx - bw/2);
          const gy = y + (by - bh/2);

          ctx.lineWidth = 4;
          ctx.strokeStyle = "rgba(202,162,74,.95)";
          ctx.strokeRect(gx, gy, bw, bh);

          const cx = gx + bw/2;
          const cy = gy + bh/2;

          ctx.beginPath();
          ctx.arc(cx, cy, 8, 0, Math.PI*2);
          ctx.fillStyle = "rgba(202,162,74,.95)";
          ctx.fill();

          const nowBelow = (cy >= lineYLocal);
          const crossed = (!rfLastBelow && nowBelow);
          rfLastBelow = nowBelow;

          const label = (best.class || best.label || "obj");
          metricText = `RF best=${label} conf=${bestScore.toFixed(2)} cy=${Math.round(cy)} lineY=${lineYLocal}`;

          if(state.running && crossed){
            doCount(`RF cross conf=${bestScore.toFixed(2)}`);
          }
        }else{
          rfLastBelow = false;
          metricText = `RF sin detección (conf≥${state.rfConf.toFixed(2)})`;
        }

        drawOverlay(metricText);
      }catch(e){
        pushEvent("RF infer error", {note:String(e?.message || e)});
        drawOverlay("RF infer error (ver bitácora)");
      }finally{
        rfInFlight = false;
      }
    }

    // ======================
    //  Loop
    // ======================
    function loop(){
      requestAnimationFrame(loop);

      clockEl.textContent = new Date().toLocaleTimeString();

      if(!video || video.readyState < 2) return;

      ensureCanvas();
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // RF
      stepRF();
    }

    // ======================
    // Boot
    // ======================
    load();
    loop();
    setInterval(()=>{ autosave(); }, 15000);

    // Limpieza al salir
    window.addEventListener("beforeunload", ()=>{ try{ stopRFWorker(); }catch(e){} });
  </script>
</body>
</html>
